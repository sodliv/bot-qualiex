# === IMPORTS ESSENCIAIS ===
import time
import pandas as pd
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from webdriver_manager.chrome import ChromeDriverManager

# === CONFIGURA√á√ïES DO CHROME PARA COLAB ===
chrome_options = Options()
chrome_options.add_argument("--no-sandbox")
chrome_options.add_argument("--disable-dev-shm-usage")
chrome_options.binary_location = "/usr/bin/google-chrome"

# === INICIAR O DRIVER ===
service = Service(ChromeDriverManager().install())
driver = webdriver.Chrome(service=service, options=chrome_options)

# === DADOS DE LOGIN ===
url_login = "https://login.qualiex.com/oauth2/authorize?client_id=132fd610-1947-4827-8414-47b07b355c45&redirect_uri=https:%2F%2Fapps3.qualiex.com%2Fcallback&response_type=token%20id_token&scope=openid%20profile%20email&state=Lw%3D%3D"
email = "smlima@bundyrefrigeration.com"
senha = "123@S0l0nqua"

# === ACESSO AO SISTEMA ===
print("Acessando o sistema...")
driver.get(url_login)

# Wait for the email field to be present on the login page
WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.NAME, "email")))
print("Sistema acessado... Seguindo para Login...")

# Printar processo:
driver.save_screenshot("Site_acessado.png")
from IPython.display import Image
Image("Site_acessado.png")

# === LOGIN COM EMAIL===
print("Fazendo login...")
driver.find_element(By.NAME, "email").send_keys(email)
print("Email Colocado...")

# Clica no bot√£o "Pr√≥ximo"
botao_next = WebDriverWait(driver, 10).until(
    EC.element_to_be_clickable((By.XPATH, "//button[contains(., 'Next') or contains(., 'Pr√≥ximo') or @type='submit']"))
)
botao_next.click()
print("Email inserido e bot√£o 'Next' clicado. Seguindo para a senha...")

# Printar processo:
driver.save_screenshot("Email_inserido.png")
Image("Email_inserido.png")

# LOGIN COM SENHA
WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.NAME, "password")))
driver.find_element(By.NAME, "password").send_keys(senha)
print("Senha tamb√©m inserida!")

# Clica diretamente no bot√£o de login por texto "Sign In"
botao_signin = WebDriverWait(driver, 10).until(
    EC.element_to_be_clickable((By.XPATH, "//button[.//span[text()='Sign In']]"))
)
print("‚úî Bot√£o 'Sign In' encontrado. Clicando...")
url_antes = driver.current_url
driver.execute_script("arguments[0].click();", botao_signin)

# Espera para poss√≠vel redirecionamento
time.sleep(15)
driver.save_screenshot("pos_signin.png")
Image("pos_signin.png")

# Verifica se tem mensagem de erro vis√≠vel
html = driver.page_source
if "invalid" in html.lower() or "erro" in html.lower():
    print("‚ö†Ô∏è Ocorreu algum erro vis√≠vel na p√°gina (senha incorreta ou outro problema).")
else:
    print("‚úÖ Nenhuma mensagem de erro vis√≠vel detectada ap√≥s login.")

# Verifica se a URL mudou
try:
    WebDriverWait(driver, 10).until(lambda d: d.current_url != url_antes)
    print("‚úî A URL mudou para:", driver.current_url)
except:
    print("‚ùå A URL n√£o mudou. Login pode ter falhado.")

# Espera um pouco e mostra a URL atual
time.sleep(10)
print("üåê URL atual ap√≥s login:", driver.current_url)

# Ir p staff
print("Indo para √°rea Staff...")
driver.get("https://apps1.qualiex.com/staff")
time.sleep(10)

# CARREGA PANILHA COM COLABORADORES
print("Carregando dados da planilha...")
df = pd.DataFrame({
    "Colaborador": [
        "Ademir Mendes Nogueira",
        "Adenilson Carlos Moraes Vieira",
        "Adriana Shimada Ferreira"
    ],
    "Funcao": [
        "Analista da Qualidade Senior",
        "Operador Multifuncional Pleno",
        "Lider de Celula de Producao"
    ]
})

# === PROCESSO DE EDI√á√ÉO DE CADA COLABORADOR ===
for index, row in df.iterrows():
    nome = row['Colaborador']
    funcao = row['Funcao']

    print(f"\nBuscando: {nome}")

    # Buscar o colaborador
    try:
        # 1. Campo de busca
        print("‚Üí Verificando campo de busca...")
        campo_busca = WebDriverWait(driver, 10).until(
            EC.presence_of_element_located((By.ID, "txtSearch-inputEl"))
        )
        print("‚úî Campo de busca encontrado")
        campo_busca.clear()
        campo_busca.send_keys(nome)
        print(f"‚úî Nome '{nome}' digitado")

        # 2. Bot√£o lupa
        print("‚Üí Aguardando bot√£o de busca (lupa)...")
        botao_lupa = WebDriverWait(driver, 10).until(
            EC.element_to_be_clickable((By.CSS_SELECTOR, "#btnSearch"))
        )
        print("‚úî Bot√£o de busca encontrado")
        botao_lupa.click()
        print(f"‚úî Bot√£o clicado, buscando perfil de '{nome}'")

        time.sleep(5)

    except Exception as e:
        print(f"‚ùå Erro ao buscar o colaborador '{nome}': {e}")
        continue



    # Clicar no resultado
    try:
        WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.XPATH, f"//div[contains(text(), '{nome}')]")))
        resultado = driver.find_element(By.XPATH, f"//div[contains(text(), '{nome}')]")
        resultado.click()

        print(f"Abrindo perfil de {nome}")

        time.sleep(2)  # espera o perfil carregar (ajuste se precisar)

        # Captura o HTML da p√°gina inteira
        html = driver.page_source

        # Procura pela palavra "Cargo" no HTML
        idx = html.find("Cargo")

        # Mostra o HTML pr√≥ximo de onde encontrou
        print(html[idx:idx+500])

    except:
        print(f"‚ùå Colaborador '{nome}' n√£o encontrado!")
        continue

    # Inserir a fun√ß√£o
    try:
        WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.NAME, "funcao"))) # Adjust if the attribute is different
        input_funcao = driver.find_element(By.NAME, "funcao")  # Ajustar se o atributo for diferente
        input_funcao.clear()
        input_funcao.send_keys(funcao)
        print(f"Fun√ß√£o atribu√≠da: {funcao}")
    except:
        print(f"‚ùå Campo de fun√ß√£o n√£o encontrado para {nome}")
        continue

    # Clicar 4x em "Avan√ßar"
    for i in range(4):
        try:
            WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.XPATH, "//button[contains(text(), 'Avan√ßar')]")))
            botao_avancar = driver.find_element(By.XPATH, "//button[contains(text(), 'Avan√ßar')]")
            botao_avancar.click()
            time.sleep(1)
        except:
            print(f"‚ö†Ô∏è Bot√£o 'Avan√ßar' n√£o encontrado na etapa {i+1}")
            break

    # Clicar em "Salvar"
    try:
        WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.XPATH, "//button[contains(text(), 'Salvar')]")))
        botao_salvar = driver.find_element(By.XPATH, "//button[contains(text(), 'Salvar')]")
        botao_salvar.click()
        print(f"‚úÖ {nome} atualizado com sucesso!")
    except:
        print(f"‚ùå Erro ao salvar dados de {nome}")

    time.sleep(3)

# === FECHAR NAVEGADOR ===
driver.quit()
print("\nProcesso conclu√≠do.")
